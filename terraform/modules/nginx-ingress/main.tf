terraform {
  required_providers {
    
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = ">= 2.23.0"
    }
    helm = {
      source  = "hashicorp/helm"
      version = ">= 2.11.0"
    }

    kubectl = {
      source  = "gavinbunney/kubectl"
      version = ">= 1.7.0"
    }
  }
}



## nginx-ingress controller

resource "helm_release" "nginx_ingress" {
  name             = "ingress-nginx"
  namespace        = "ingress-nginx"
  create_namespace = true
  repository       = "https://kubernetes.github.io/ingress-nginx"
  chart            = "ingress-nginx"
  version          = "4.8.3"
  atomic           = false
  lint             = true
  wait             = true
  timeout          = 600


  set  {
      name  = "controller.service.type"
      value = "LoadBalancer"
    }
    set {
      name  = "controller.service.annotations.service\\.beta\\.kubernetes\\.io/aws-load-balancer-type"
      value = "nlb"
    }
    set {
      name  = "controller.service.annotations.service\\.beta\\.kubernetes\\.io/aws-load-balancer-scheme"
      value = "internet-facing"
    }

    set {
      name  = "controller.service.annotations.service\\.beta\\.kubernetes\\.io/aws-load-balancer-nlb-target-type"
      value = "instance"
    }
    set {
      name  = "controller.hostNetwork"
      value = "true"
    }

    set {
      name  = "controller.replicaCount"
      value = "1"
    }
    set {
      name  = "controller.service.externalTrafficPolicy"
      value = "Local"
    }

  depends_on = [var.cluster_endpoint]
}



